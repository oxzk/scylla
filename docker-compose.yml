version: '3.8'

services:
    # PostgreSQL Database
    postgres:
        image: postgres:15-alpine
        container_name: scylla-postgres
        restart: unless-stopped
        environment:
            POSTGRES_DB: scylla
            POSTGRES_USER: scylla
            POSTGRES_PASSWORD: scylla_password
            POSTGRES_INITDB_ARGS: '--encoding=UTF8'
        volumes:
            - postgres_data:/var/lib/postgresql/data
        ports:
            - '5432:5432'
        healthcheck:
            test: ['CMD-SHELL', 'pg_isready -U scylla']
            interval: 10s
            timeout: 5s
            retries: 5
        networks:
            - scylla-network

    # Scylla Application
    scylla:
        build:
            context: .
            dockerfile: Dockerfile
        container_name: scylla-app
        restart: unless-stopped
        depends_on:
            postgres:
                condition: service_healthy
        environment:
            # Database Configuration
            DB_URL: postgresql://scylla:scylla_password@postgres:5432/scylla
            DB_MIN_POOL_SIZE: 5
            DB_MAX_POOL_SIZE: 20

            # Server Configuration
            HOST: 0.0.0.0
            PORT: 8899
            DEBUG: 'false'

            # Proxy Validation Configuration
            PROXY_TEST_URL: https://httpbin.org/ip
            PROXY_TEST_TIMEOUT: 20
            MAX_CONCURRENT_VALIDATORS: 50

            # Spider Configuration
            MAX_CONCURRENT_SPIDERS: 3
            CRAWL_INTERVAL: 3600
            VALIDATE_INTERVAL: 60
            CLEANUP_INTERVAL: 7200
            
        ports:
            - '8899:8899'
        volumes:
            - ./logs:/app/logs
        networks:
            - scylla-network
        healthcheck:
            test: ['CMD', 'curl', '-f', 'http://localhost:8899/api/health']
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s

volumes:
    postgres_data:
        driver: local

networks:
    scylla-network:
        driver: bridge
